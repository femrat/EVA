# EVA Manual
这是EVA的手册。
~~未尽事宜，请直接看代码…~~

阅读本手册前，请先阅读 [QuickStart.md](https://github.com/femrat/EVA/blob/master/QuickStart.md) 。

# EVA的约定

## 关于文件名和目录名
**EVA不支持任何文件名和目录名中出现空格**。请勿使用空格。
**除数据集文件名外，任何文件和目录都应避免出现除特别说明外的`-`符号**。
在EVA中，`-`有特别的用途，例如分割项目名称和并行数量、实验使用的数据集和编号等。

## 关于`PATH`环境变量
`script`目录应被加入到`PATH`环境变量中。

## 关于同时使用多个EVA
**不建议部署多个EVA**。
~~你不嫌乱吗？~~

如果一定要在同一台电脑上部署多个EVA，那么，请确保他们都使用相同的`script`目录，并将任意一个`script`目录添加至`PATH`。
这里可以复制`script`目录，或软链接（`ln -s`）到同一个目录。
- 如果选择复制，那么这两份EVA将完全独立运行。
- 如果选择软链接，那么两份EVA将共享同一套锁。
具体来说，当一个EVA运行实验时，其他EVA将等待其运行完毕才能运行。


# 配置EVA
当前EVA包含一个配置文件，其位于`script/config`。
EVA配置文件遵循Bash语法。请注意赋值等号的两边不得有空格。
EVA每次执行时会自动检查`config`文件，如果发现有必要变量缺少或`config`文件不存在，会自动以默认值设置并写入`config`。

EVA参数如下：
-  MACHINE：机器ID

示例：`MACHINE=machine`

`.sum`文件的命名将使用MACHINE作为文件名的最后一部分。
这使得将多台机器上的汇总文件拷贝到一起时仍可以分辨文件来源，并且避免重名。
MACHINE不得包含空格和“-”，且其应在集群中唯一，不与其他机器重复。
默认值为主机名（`hostname`），其中`-`等被替换。


# 数据集：data目录

对于数据集`M`，其所有文件应至于`data/M/files/`目录。
`data/M/files/`中的文件名允许出现`-`，但不许出现空格。

`/data/M/files/`目录中允许出现“多余的”文件，即不属于该数据集的文件。
`M`数据集包括的文件，由`data/M/list`文件定义。
在该文件内，每个文件名占一行。

例如：
```
~/EVA/data
└── M
    ├── files
    │   ├── a.cnf
    │   └── b.cnf
    └── list
```
其中list文件如下：
```
a.cnf
b.cnf
```

有时，每个传入的实例都有一个或多个属性，例如理论最优解等。

`/data/M/list`文件可以包含额外的数据，使用**空格**分隔（不要使用TAB等别的空白字符）。
文件名后的部分将被作为参数，紧跟着文件名被传入程序。例如如果list文件内容为：
```
a.cnf 2
b.cnf 3
```
则在传入`a.cnf`给项目程序时，`argv[1]="a.cnf"`, `argv[2]="2"`。

如果对于同一个数据集，有时需要传入额外数据，有时不需要，最佳实践是创建两个测试集，如`M`和`Mopt`，其中后者的`files`文件夹为到前者的软连接。


# 项目：eval目录

`eval`目录包括所有的项目。

对于一个项目`eval/ALG_1-p4/`，其对应的可执行文件默认为`eval/ALG_1-p4/ALG_1.out`。
这是常规的文件位置，无需做任何特别设置就可以使用。
`eva new`命令可以自动创建`ALG_1-p4`文件夹，并将可执行文件拷入。

对于一些程序，可能需要非常规地对待，例如，该程序需要将实例文件以`0`管道（`stdin`）传入，而不是在`argv[1]`指定实例文件名。
以及，这些程序的结果输出也不是在最后一行，而是在程序的中间打印结果。
遇到这种程序，可以使用EVA提供的备用运行方案：`run.sh`和`collect.sh`。

- `run.sh`

`eval/ALG_1-p4/run.sh`重新定义了`ALG_1-p4`的运行方式。
EVA发现`run.sh`存在时，将执行`run.sh`而不是`ALG_1.out`。
原本传入`ALG_1.out`的参数，将悉数传入`run.sh`。
`run.sh`需要负责将参数传给项目程序，并将输出打印到管道`1`（`stdout`）或`2`（`stderr`）。

`run.sh`运行时的工作目录为`eval/ALG_1-p4`。

一个`run.sh`的示例：
```
~/runsolver --timestamp -C 300 ./*.out $@
```

若`run.sh`存在但未被赋予执行权限，则运行时会报错并跳过此项目。

- `collect.sh`

一些程序的结果输出可能在打印出的数据流的中间。
这时，`.sum`文件将无法正常产生。
`collect.sh`提供了重新定义`.sum`文件生成逻辑的机会。
`collect.sh`运行目录为`eval/ALG_1-p4`，第一个参数（`$1`）为记录程序输出的`.res`文件的**相对路径**。

`collect.sh`需要读取`$1`，处理并打印结果到管道`1`（`stdout`）。
例如：
```
#!/bin/bash
echo -n "$1 "
grep '^o' $1 | tail -n1
```


# 实验
实验是一个项目中的一部分，包括自己独立的参数组合和规定数据集。

## 添加实验
使用`eva add`命令可以轻松创建新实验。
命令格式为：`eva add <Benchmark> [<param1> <param2> ...]`。
其中`<Benchmark>`必选，其指定了该实验使用什么数据集。
其后跟的参数可选，例如：
```
eva add M
eva add M 1 2 3 4
```
将创建两个实验目录（`M-0000`和`M-0001`），其中第一个实验无参数，第二个实验的参数是`1 2 3 4`。
第二个实验的参数保存在`eval/ALG_1-p4/M-0001/param`文件中。
该文件中仅第一行为传入参数，后续行将被忽略。

`eva add`对于每个数据集，都有独立的计数。即可能出现`M-0000`和`Mopt-0000`。


## 查询参数
在项目目录，即`eval/ALG_1-p2`下，执行`eva show M-0000 M-0001`将显示`M-0000`和`M-0001`实验的参数配置。
执行`eva show`将显示所有实验的参数。


## 运行实验
`eva start`命令可以运行在项目目录（`eval/ALG_1-p4`）中，也可以在`eval`目录中使用。

在`eval/ALG_1-p4`目录中，执行`eva start`，将启动所有实验。其中，已运行过的实验内的实例将被跳过。
也可以指定运行特定的实验：`eva start M-0000 M-0001`。

方便起见，EVA同时支持在项目目录的上层，也即`eval`目录运行`eva start`。
切换至eval目录后，执行`eva start ALG_1-p2 ALG_1-p1`，等同于：
```
cd ALG_1-p2
eva start
cd ../ALG_1-p1
eva start
cd ..
```

运行实验后，每个实例对应的日志在实验的`log`目录下。
如`M-0000`实验下，`a.cnf`实例对应的日志文件在`M-0000/log/a.cnf.res`。

实验运行完毕后，将自动生成`.sum`文件，位于`M-0000/ALG_1-p2--M-0000--machine.sum`。
该文件汇总了`M-0000/log`下的实验结果的最后一行，或`collect.sh`定义的行为。
汇总操作时，EVA将读取数据集列表，按照列表顺序依次读取结果文件。
所以汇总文件的顺序总保证和数据集列表文件的顺序一致。

`.sum`文件创建后，该实验目录及其内的文件将被置为只读。

`eva start`具有排他性。EVA保证不会出现两个`eva start`同时运行。
如果上一个实验尚未结束时执行`eva start`，则新的实验会排队等待上一个实验完成，然后自动开始。
EVA不对排队顺序做任何保证。
也即如果当前`eva start`完成时，有两个或更多`eva start`正在排队，则哪个`eva start`会运行是未知的。

提示：`eva start`运行时的文件锁位于`script/.evalock`。
当存在多个EVA时，需要当心。


## 复制结果
`.sum`文件位于实验文件夹内。
通过`eva scp`命令，可以轻松将指定实验或项目的`.sum`文件全部拷贝至指定文件夹或主机。
例如，位于`eval`目录中，执行`eva scp ALG_1-p2 ALG_2-p2 user@192.168.0.2:log`

则`ALG_1-p2`和`ALG_2-p2`项目中所有有效`.sum`文件都会被拷贝至`user@192.168.0.2:log`。

如果在项目文件夹中执行`eva scp`，例如`eva scp M-0000 M-0001 user@192.168.0.2:log`

则指定的实验中的`.sum`文件（如果存在）将被拷贝至`user@192.168.0.2:log`。
与`eva start`命令风格一样，如果没有提供任何实验，则默认是当前目录下的全部实验文件夹。

提示：`eva scp`可以通过ssh通道拷贝文件，但在非ssh模式下，也可以自动调用cp向本地拷贝。所以实验文件夹位置不一定非要是远程位置，本地文件夹也可以。

**警告**：由于远程位置无法检查是否是文件夹，所以在特殊情况下可能造成异常覆盖：若目标是文件而不是文件夹，同时仅有一个汇总文件需要拷贝，则该汇总文件会覆盖目标文件。这超出了设计用意，请在确认执行`eva scp`前做好确认。


# 意外处理：实验运行时EVA中断
当发生意外时，EVA在运行实验途中终止。
该种情况下，可以手动删除意外终止时正在写入的测试日志，使用`eva start`命令继续运行。
如不删除日志，则由于EVA无法判定该程序是否已正确终止，所以将跳过该实例。
但如果意外发生时的项目的并行数量设置为2及以上，建议操作是删除对应实验下的log文件夹，重新运行该实验，以免可重复性受到潜在影响。
重新运行的EVA将不对已全部完成的实验进行汇总操作产生`.sum`。此时需要执行`eva col M-0000 M-0001 ...`进行手动汇总。


# 监控与审计：EVA的日志
EVA的实验私有日志在实验文件夹下的`cmd.log`中。
其内容为每个实例运行的时间。

EVA的全局日志位于`log`目录下，分为两种：

- `cmd.log`：每个实验的`cmd.log`日志的合集。
- `eva.log`：记录eva所有输出。



